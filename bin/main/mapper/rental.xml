<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper
	namespace="com.bclass.arts_center.repository.interfaces.RentalRepository">

	<select id="selectByLocation"
		resultType="com.bclass.arts_center.dto.request.RequestHoleDto">
		SELECT l.id, l.location, h.name, h.price, MIN(h.id) AS
		hole_id
		FROM hole_tb AS h
		JOIN location_tb AS l ON h.location_id = l.id
		AND l.id = #{id}
		GROUP BY l.id, l.location, h.name, h.price;


	</select>

	<select id="selectByTime"
		resultType="com.bclass.arts_center.dto.request.RequestHoleDto">
		select t.id, t.start_time, t.end_time
		from time_tb as t
		join
		hole_tb as h
		on h.time_id = t.id
		where h.location_id = #{locationId}
		group by time_id;
	</select>

	<select id="selectByLocation2"
		resultType="com.bclass.arts_center.dto.request.RequestRentPlaceDto">

		SELECT h.name, t.id, t.start_time, t.end_time
		FROM hole_tb AS h
		JOIN time_tb AS t ON h.time_id = t.id
		WHERE h.location_id = #{locationId}
		AND NOT EXISTS (
		SELECT 1
		FROM rent_place_reservation_tb AS r
		WHERE r.location_id = h.id
		AND r.start_date = #{startDate}
		AND r.end_date = #{endDate}
		AND (
		(r.start_time &lt;= t.start_time AND r.end_time &gt; t.start_time)
		OR (r.start_time &lt; t.end_time AND r.end_time &gt;= t.end_time)))
	</select>

	<insert id="insertRental">
		INSERT INTO
		rent_place_reservation_tb(start_date,end_date,start_time,end_time,user_id,hole_id,location_id)
		VALUES(
		#{startDate},#{endDate},#{startTime},#{endTime},#{userId},#{holeId},#{locationId}
		);
	</insert>
	
	<select id="selectByDateAndLocation"
		resultType="com.bclass.arts_center.dto.request.RequestRentPlaceDto">
		SELECT *
		FROM rent_place_reservation_tb AS r
		WHERE (r.start_date BETWEEN #{startDate} AND #{endDate}
		OR r.end_date BETWEEN #{startDate} AND #{endDate})
        AND hole_id=#{holeId};
	</select>



</mapper>