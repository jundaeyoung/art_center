<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper
	namespace="com.bclass.arts_center.repository.interfaces.ReviewRepository">

	<!-- 작성자 : 전대영 리뷰 최신순 -->
	<select id="selectReviewByNewest"
		resultType="com.bclass.arts_center.dto.request.RequestReviewDto">
		select s.id as showId,sc.show_type,u.id as
		userId,r.review_creation_date
		,r.id AS reviewId, r.rating, s.title,
		s.content,s.img_route, r.content
		as reviewContent,
		u.user_name from
		review_tb as r
		join show_tb as s
		on
		r.show_id = s.id
		join user_tb as u
		on
		r.user_id = u.id
		join category_tb as sc
		on s.show_type_id = sc.id
		order
		by
		r.id desc
		limit #{begin},
		#{range};
	</select>

	<!-- 작성자 : 전대영 리뷰 높은순 -->
	<select id="selectReviewByHighesRated"
		resultType="com.bclass.arts_center.dto.request.RequestReviewDto">
		select s.id as showId,sc.show_type,u.id as userId ,r.id AS
		reviewId,
		r.rating, s.title,
		s.content,s.img_route,r.review_creation_date
		,r.content as
		reviewContent,
		u.user_name from
		review_tb as r
		join show_tb
		as s
		on
		r.show_id = s.id
		join user_tb as u
		on r.user_id = u.id
		join category_tb
		as sc
		on s.show_type_id = sc.id
		order by
		r.rating desc ,
		r.review_creation_date desc
		limit #{begin},
		#{range};
	</select>


	<!-- 작성자 : 전대영 리뷰 낮은순 -->
	<select id="selectReviewByRowestRated"
		resultType="com.bclass.arts_center.dto.request.RequestReviewDto">
		select s.id as showId,u.id as userId ,r.id AS reviewId,
		r.rating,sc.show_type, s.title,
		s.content,s.img_route,r.review_creation_date
		,r.content as
		reviewContent,
		u.user_name from
		review_tb as r
		join show_tb
		as s
		on
		r.show_id = s.id
		join user_tb as u
		on r.user_id = u.id
		join category_tb
		as sc
		on s.show_type_id = sc.id
		order by
		r.rating asc ,
		r.review_creation_date desc
		limit #{begin},
		#{range};
	</select>


	<!-- 작성자 : 전대영 리뷰 카운터 -->
	<select id="selectReviewCount" resultType="Integer">
		 select count(*) from
		review_tb as r
		join show_tb as s
		on
		r.show_id = s.id
		join user_tb as u
		on
		r.user_id = u.id
		join category_tb as sc
		on s.show_type_id = sc.id
		order
		by
		r.id desc;
	</select>

	<!-- 작성자 : 전대영 공연 select -->
	<select id="selectReviewByCategory"
		resultType="com.bclass.arts_center.dto.request.RequestReviewDto">
		select s.id as showId,u.id as userId ,r.id AS
		reviewId,sc.show_type, r.rating, s.title,
		s.content,s.img_route,r.review_creation_date ,r.content as
		reviewContent,
		u.user_name from
		review_tb as r
		join show_tb as s
		on
		r.show_id = s.id
		join user_tb as u
		on r.user_id = u.id
		join category_tb
		as sc
		on s.show_type_id = sc.id
		where sc.show_type=#{category}
		order by
		r.rating desc , r.review_creation_date
		desc
		limit #{begin},
		#{range};
	</select>

	<select id="selectReviewByCategoryCount"
		resultType="Integer">
		select
		count(*) as count from
		review_tb as r
		join show_tb as s
		on s.id = r.show_id
		join category_tb as c
		on s.show_type_id= c.id
		where
		c.show_type= #{category}
	</select>


	<select id="selectReviewByShow" resultType="com.bclass.arts_center.dto.request.RequestReviewDto">
		select s.id as
		showId,u.id as userId ,r.id AS
		reviewId,sc.show_type, r.rating,
		s.title,
		s.content,s.img_route,r.review_creation_date ,r.content as
		reviewContent,
		u.user_name from
		review_tb as r
		join show_tb as s
		on
		r.show_id = s.id
		join user_tb as u
		on r.user_id = u.id
		join category_tb
		as sc
		on s.show_type_id = sc.id
		where s.title like #{showName} 
		order by
		r.rating desc , r.review_creation_date
		desc
		limit #{begin},
		#{range};
	</select>
	
	<select id="selectReviewCountByShow"
		resultType="Integer">
		select
		count(*) as count from
		review_tb as r
		join show_tb as s
		on s.id = r.show_id
		join category_tb as c
		on s.show_type_id= c.id
		where
		c.show_type= #{category}
	</select>
	<!-- 리뷰 작성 -->
	<insert id="insertReview">
	INSERT INTO review_tb(content, rating, user_id, show_id)
        VALUES(#{content}, #{rating}, #{userId}, #{showId})
	</insert>
	
	<!-- 작성자 : 공연 타입별 조회 -->
	<select id="selectMyTiketDtoByShowType" resultType="com.bclass.arts_center.dto.MyTiketDto">
		SELECT t.user_id, s.img_route, s.title,
		s.content,l.location, h.name, se.seat_name, sd.show_date,
		sd.show_time, c.show_type, r.content AS reviewContent, t.show_id, r.rating
		from ticketing_tb AS t
		JOIN payment_tb AS p
		ON t.id = p.ticketing_id
		JOIN show_tb AS s
		ON t.show_id = s.id
		JOIN show_datetime_tb AS sd
		ON sd.id = t.show_datetime_id
		JOIN seat_tb AS se
		ON t.seat_id = se.seat_id
		JOIN hole_tb AS h
		ON h.id = se.hole_id
		JOIN location_tb AS l
		ON l.id = h.location_id
		JOIN category_tb AS c
		ON c.id = s.show_type_id
        LEFT JOIN review_tb AS r
        ON r.show_id = s.id
		WHERE t.user_id = #{userId}
		AND t.payment_status = 1
		AND sd.show_date > now()
		AND c.show_type = #{showType}
		ORDER BY show_date DESC;
	</select>
	
	
	
</mapper>


